name: Submit Sitemap to Baidu

on:
  workflow_dispatch:
  schedule:
    # 每天北京时间早上8点执行 (UTC+8 = UTC+0-8)
    - cron: '0 0 * * *'
  push:
    branches: [ main ]
    paths:
      - 'sitemap.xml'

jobs:
  submit-sitemap:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Parse sitemap
      env:
        SITEMAP_URL: ${{ secrets.SITEMAP_URL }}
      run: |
        python parse_sitemap.py --sitemap "${SITEMAP_URL}" --verbose
        
    - name: Submit URLs to Baidu
      env:
        SITE_URL: ${{ secrets.SITE_URL }}
        BAIDU_TOKEN: ${{ secrets.BAIDU_TOKEN }}
      run: |
        python submit_baidu.py --site "${SITE_URL}" --token "${BAIDU_TOKEN}" --urls-file urls.txt --verbose
        
    - name: Display URLs count
      run: |
        echo "URLs数量:"
        wc -l urls.txt
        
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: baidu-seo-results
        path: |
          urls.txt
          parse_sitemap.log
          submit_baidu.log
        retention-days: 30
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add urls.txt parse_sitemap.log submit_baidu.log
        if git diff --cached --quiet; then
          echo "没有变化需要提交"
        else
          git commit -m "更新URL列表和日志文件"
          git push
        fi
